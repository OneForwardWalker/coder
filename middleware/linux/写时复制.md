# 写时复制
[reference](https://zhuanlan.zhihu.com/p/366707663)
## linux fork和exec的区别
* fork是创建一个新的进程，该进程几乎是当前线程的一个完全拷贝
* exec用来取代当前的进程
## 虚拟内存和物理内存
* 物理内存
就是电脑的内存条，如果安装了2GB的内存条，那么系统就拥有0-2GB的物理内存空间
* 虚拟内存
虚拟内存是用软件虚拟的，在32位的操作系统中，每个进程都独占4GB的虚拟内存空间

虚拟内存需要映射到物理内存才能使用，如果使用没有映射的内存地址，将会导致缺页异常。
![](https://pic1.zhimg.com/80/v2-6475c1b0365c95e8382a425903e9351c_720w.jpg)
如上图所示，进程A和B的虚拟内存地址是一样的，但是映射到了不同的物理内存地址，这就是不同的进程之间的相同虚拟内存互不影响的原因。虚拟内存是以**进程**为单位存在的
## 写时复制
* 不同的虚拟内存映射到相同的物理内存就实现了内存共享的机制
![](https://pic4.zhimg.com/80/v2-b8636a4e275eb34cdd70b0f6ab72f32f_720w.jpg)
linux为了加速子进程的创建与节省内存使用的原因，实现了**写时复制**的机制。
* 原理
![](https://pic4.zhimg.com/80/v2-87ed5a2084718934efb43d8448ee0137_720w.jpg)
创建子进程的时候，将父进程的虚拟内存页和子进程的虚拟内存页映射到相同的物理内存，并且将虚拟内存页都设置成只读，对内存页作修改后，会发生缺页异常。内核会进行物理内存页的拷贝。